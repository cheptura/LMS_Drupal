#!/bin/bash

# RTTI Moodle - ะญะบัััะตะฝะฝะฐั ะพััะฐะฝะพะฒะบะฐ Cron
# ะััะฐะฝะฐะฒะปะธะฒะฐะตั ะฒัะต ะทะฐะฟััะตะฝะฝัะต Moodle cron ะฟัะพัะตััั

echo "=== RTTI Moodle - ะญะบัััะตะฝะฝะฐั ะพััะฐะฝะพะฒะบะฐ Cron ==="
echo "๐ ะะตะผะตะดะปะตะฝะฝะฐั ะพััะฐะฝะพะฒะบะฐ ะฒัะตั cron ะฟัะพัะตััะพะฒ"
echo "๐ ะะฐัะฐ: $(date)"
echo

# ะัะพะฒะตัะบะฐ ะฟัะฐะฒ root
if [ "$EUID" -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ: ะะฐะฟัััะธัะต ัะบัะธะฟั ั ะฟัะฐะฒะฐะผะธ root"
    echo "ะัะฟะพะปัะทัะนัะต: sudo $0"
    exit 1
fi

echo "๐ ะะพะธัะบ ะทะฐะฟััะตะฝะฝัั Moodle cron ะฟัะพัะตััะพะฒ..."

# ะะฐะนัะธ ะฒัะต ะฟัะพัะตััั ัะฒัะทะฐะฝะฝัะต ั cron.php
CRON_PIDS=$(pgrep -f "cron.php" 2>/dev/null)
CLI_PIDS=$(pgrep -f "cli/cron" 2>/dev/null)
PHP_CRON_PIDS=$(ps aux | grep "php.*cron" | grep -v grep | awk '{print $2}')

ALL_PIDS="$CRON_PIDS $CLI_PIDS $PHP_CRON_PIDS"
UNIQUE_PIDS=$(echo $ALL_PIDS | tr ' ' '\n' | sort -u | tr '\n' ' ')

if [ -n "$UNIQUE_PIDS" ]; then
    echo "๐ ะะฐะนะดะตะฝั ัะปะตะดัััะธะต ะฟัะพัะตััั:"
    ps aux | grep -E "(cron\.php|cli/cron)" | grep -v grep
    echo
    echo "๐ข PID ะฟัะพัะตััะพะฒ: $UNIQUE_PIDS"
    echo
    
    # ะัะณะบะพะต ะทะฐะฒะตััะตะฝะธะต
    echo "1๏ธโฃ ะะพะฟััะบะฐ ะผัะณะบะพะณะพ ะทะฐะฒะตััะตะฝะธั (SIGTERM)..."
    for pid in $UNIQUE_PIDS; do
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            echo "   ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตัั $pid..."
            kill "$pid" 2>/dev/null
        fi
    done
    
    # ะะดะตะผ 5 ัะตะบัะฝะด
    echo "โฑ๏ธ  ะะถะธะดะฐะฝะธะต 5 ัะตะบัะฝะด..."
    sleep 5
    
    # ะัะพะฒะตััะตะผ, ััะพ ะทะฐะฒะตััะธะปะพัั
    REMAINING_PIDS=$(pgrep -f "cron.php" 2>/dev/null)
    REMAINING_CLI=$(pgrep -f "cli/cron" 2>/dev/null)
    REMAINING_ALL="$REMAINING_PIDS $REMAINING_CLI"
    
    if [ -n "$REMAINING_ALL" ]; then
        echo "โ๏ธ  ะะตะบะพัะพััะต ะฟัะพัะตััั ะฒัะต ะตัะต ัะฐะฑะพัะฐัั"
        echo "2๏ธโฃ ะัะธะฝัะดะธัะตะปัะฝะพะต ะทะฐะฒะตััะตะฝะธะต (SIGKILL)..."
        
        for pid in $REMAINING_ALL; do
            if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
                echo "   ะัะธะฝัะดะธัะตะปัะฝะพ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตัั $pid..."
                kill -9 "$pid" 2>/dev/null
            fi
        done
        
        sleep 2
    fi
    
    # ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
    FINAL_CHECK=$(pgrep -f "cron.php" 2>/dev/null)
    if [ -z "$FINAL_CHECK" ]; then
        echo "โ ะัะต cron ะฟัะพัะตััั ััะฟะตัะฝะพ ะพััะฐะฝะพะฒะปะตะฝั"
    else
        echo "โ ะะตะบะพัะพััะต ะฟัะพัะตััั ะฒัะต ะตัะต ัะฐะฑะพัะฐัั: $FINAL_CHECK"
        echo "๐ง ะะพะฟัะพะฑัะนัะต ะฟะตัะตะทะฐะณััะทะธัั ัะตัะฒะตั: sudo reboot"
    fi
else
    echo "โน๏ธ  ะะฐะฟััะตะฝะฝัะต cron ะฟัะพัะตััั ะฝะต ะฝะฐะนะดะตะฝั"
fi

echo
echo "3๏ธโฃ ะัะบะปััะตะฝะธะต ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ cron ะฝะฐ ะฒัะตะผั ัััะฐะฝะพะฒะบะธ..."

# ะัะตะผะตะฝะฝะพ ะพัะบะปััะฐะตะผ cron ัะฐะนะป
if [ -f "/etc/cron.d/moodle" ]; then
    echo "๐ง ะัะตะผะตะฝะฝะพะต ะพัะบะปััะตะฝะธะต ัะธััะตะผะฝะพะณะพ cron..."
    mv /etc/cron.d/moodle /etc/cron.d/moodle.disabled
    echo "โ ะกะธััะตะผะฝัะน cron ะพัะบะปััะตะฝ (ัะฐะนะป ะฟะตัะตะธะผะตะฝะพะฒะฐะฝ ะฒ moodle.disabled)"
else
    echo "โน๏ธ  ะกะธััะตะผะฝัะน cron ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ"
fi

# ะะตัะตะทะฐะฟััะบะฐะตะผ cron ัะปัะถะฑั
echo "๐ ะะตัะตะทะฐะฟััะบ cron ัะปัะถะฑั..."
systemctl restart cron

echo
echo "4๏ธโฃ ะัะพะฒะตัะบะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั..."
CURRENT_CRON=$(pgrep -f "cron.php" 2>/dev/null)
if [ -z "$CURRENT_CRON" ]; then
    echo "โ Cron ะฟัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั"
else
    echo "โ ะัะต ะตัะต ัะฐะฑะพัะฐัั ะฟัะพัะตััั: $CURRENT_CRON"
fi

echo
echo "๐ฏ CRON ะะกะขะะะะะะะ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะขะตะฟะตัั ะผะพะถะฝะพ ะฑะตะทะพะฟะฐัะฝะพ ะฟัะพะดะพะปะถะธัั ัััะฐะฝะพะฒะบั Moodle"
echo "๐ง ะะพัะปะต ะทะฐะฒะตััะตะฝะธั ัััะฐะฝะพะฒะบะธ ะทะฐะฟัััะธัะต ะดะปั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั cron:"
echo "   sudo ./manage-cron.sh"
echo "   ะัะฑะตัะธัะต: 1) ะะฐัััะพะธัั ัะธััะตะผะฝัะน cron"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo
echo "๐ก ะัะปะธ ะฝัะถะฝะพ ะพััะฐะฝะพะฒะธัั cron ัะฝะพะฒะฐ ะฒะพ ะฒัะตะผั ัััะฐะฝะพะฒะบะธ:"
echo "   ะะฐะถะผะธัะต Ctrl+C ะฒ ัะตัะผะธะฝะฐะปะต ัััะฐะฝะพะฒะบะธ"
echo "   ะะฐัะตะผ ะทะฐะฟัััะธัะต: sudo ./stop-cron.sh"
