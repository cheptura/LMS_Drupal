#!/bin/bash

# RTTI Moodle - –®–∞–≥ 9: –ü–æ—Å—Ç-—É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
# –°–µ—Ä–≤–µ—Ä: lms.rtti.tj (92.242.60.172)

echo "=== RTTI Moodle - –®–∞–≥ 9: –ü–æ—Å—Ç-—É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ==="
echo "üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
echo "üìÖ –î–∞—Ç–∞: $(date)"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root"
    exit 1
fi

MOODLE_DIR="/var/www/moodle"

echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Moodle..."
if [ ! -f "$MOODLE_DIR/config.php" ]; then
    echo "‚ùå Moodle –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–±)
if [ -f "/var/moodledata/install.lock" ]; then
    echo "‚úÖ Moodle —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–∞–π–¥–µ–Ω install.lock)"
elif [ -f "$MOODLE_DIR/../moodledata/install.lock" ]; then
    echo "‚úÖ Moodle —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–∞–π–¥–µ–Ω install.lock)"
else
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ CLI
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ CLI..."
    if sudo -u www-data php -r "
define('CLI_SCRIPT', true);
require_once '$MOODLE_DIR/config.php';
require_once '$MOODLE_DIR/lib/clilib.php';
if (file_exists(\$CFG->dataroot . '/install.lock')) {
    echo 'OK';
} else {
    echo 'MISSING';
}
" 2>/dev/null | grep -q "OK"; then
        echo "‚úÖ Moodle —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    else
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: install.lock –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        echo "‚ÑπÔ∏è  –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Moodle"
    fi
fi

echo "2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
sudo -u www-data php $MOODLE_DIR/admin/cli/install_language.php --lang=ru

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
sudo -u www-data php $MOODLE_DIR/admin/cli/install_language.php --lang=en

echo "3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ CLI
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=cachejs --set=1
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=cachetemplates --set=1
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=enablegzip --set=1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–π
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=sessiontimeout --set=7200

echo "4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=forcelogin --set=0
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=forceloginforprofiles --set=1
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=opentogoogle --set=0
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=protectusernames --set=1

echo "5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤..."
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=maxbytes --set=104857600  # 100MB

echo "6. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫—É—Ä—Å–æ–≤..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π PHP —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
cat > /tmp/create_categories.php << 'PHPEOF'
<?php
define('CLI_SCRIPT', true);
require_once('/var/www/moodle/config.php');
require_once($CFG->libdir . '/adminlib.php');

$categories = [
    '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏',
    '–¢–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏', 
    '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏',
    '–Ø–∑—ã–∫–æ–≤—ã–µ –∫—É—Ä—Å—ã',
    '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ'
];

foreach ($categories as $name) {
    if (!$DB->record_exists('course_categories', array('name' => $name))) {
        $category = new stdClass();
        $category->name = $name;
        $category->description = '–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ' . $name;
        $category->parent = 0;
        $category->sortorder = 999;
        $category->coursecount = 0;
        $category->visible = 1;
        $category->timemodified = time();
        $category->depth = 1;
        $category->path = '';
        
        $id = $DB->insert_record('course_categories', $category);
        $category->path = '/' . $id;
        $DB->update_record('course_categories', $category);
        
        echo '–°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ' . $name . "\n";
    } else {
        echo '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ' . $name . "\n";
    }
}
echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ\n";
PHPEOF

# –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç
if sudo -u www-data php /tmp/create_categories.php 2>/dev/null; then
    echo "‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫—É—Ä—Å–æ–≤ —Å–æ–∑–¥–∞–Ω—ã"
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f /tmp/create_categories.php

echo "7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è..."
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=theme --set=boost

echo "8. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π..."
# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —Ä–æ–ª–µ–π
sudo -u www-data php $MOODLE_DIR/admin/cli/reset_roles.php

echo "9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ email..."
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=noreplyaddress --set="noreply@rtti.tj"
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=supportemail --set="support@rtti.tj"

echo "10. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤..."
# –í–∫–ª—é—á–µ–Ω–∏–µ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=enablewebservices --set=1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sudo -u www-data php $MOODLE_DIR/admin/cli/cfg.php --name=enablemobilewebservice --set=1

echo "11. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è..."
cat > /etc/cron.d/moodle-maintenance << 'EOF'
# Moodle maintenance tasks

# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ (–≤ 3:00)
0 3 * * * www-data /usr/bin/php /var/www/moodle/admin/cli/logs.php --cleanup >/dev/null 2>&1

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 4:00)
0 4 * * 0 root sudo -u postgres vacuumdb --analyze moodle >/dev/null 2>&1

# –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (1 —á–∏—Å–ª–æ –≤ 5:00)
0 5 1 * * www-data /usr/bin/php /var/www/moodle/admin/cli/check_database_schema.php >/dev/null 2>&1
EOF

echo "12. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
cat > /root/moodle-performance-monitor.sh << 'EOF'
#!/bin/bash
echo "=== Moodle Performance Monitor ==="
echo "–í—Ä–µ–º—è: $(date)"
echo

echo "1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –∏ –ø–∞–º—è—Ç–∏:"
top -bn1 | grep -E "(Cpu|Mem)" | head -2

echo -e "\n2. –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã PHP:"
ps aux | grep php-fpm | wc -l

echo -e "\n3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL:"
sudo -u postgres psql -d moodle -c "SELECT count(*) as connections FROM pg_stat_activity;" 2>/dev/null | tail -2 | head -1

echo -e "\n4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis:"
redis-cli -a $(grep "–ü–∞—Ä–æ–ª—å:" /root/moodle-redis-credentials.txt | awk '{print $2}') info stats | grep -E "(keyspace_hits|keyspace_misses|connected_clients)"

echo -e "\n5. –†–∞–∑–º–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–æ–≤:"
du -sh /var/www/moodle /var/moodledata /var/cache/moodle 2>/dev/null

echo -e "\n6. –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ:"
df -h | grep -E "(Filesystem|/var|/)"

echo -e "\n7. –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
for service in nginx php8.3-fpm postgresql redis-server; do
    status=$(systemctl is-active $service)
    echo "$service: $status"
done

echo -e "\n8. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Nginx:"
tail -5 /var/log/nginx/error.log 2>/dev/null || echo "–ù–µ—Ç –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫"
EOF

chmod +x /root/moodle-performance-monitor.sh

echo "13. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã..."
cat > /root/moodle-system-update.sh << 'EOF'
#!/bin/bash
echo "=== Moodle System Update ==="

# –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
echo "–í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è..."
sudo -u www-data php /var/www/moodle/admin/cli/maintenance.php --enable

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Ubuntu..."
apt update && apt upgrade -y

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ PHP –ø–∞–∫–µ—Ç–æ–≤
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ PHP..."
apt install -y php8.3-cli php8.3-fpm php8.3-pgsql php8.3-redis php8.3-gd php8.3-curl php8.3-zip php8.3-mbstring php8.3-xml php8.3-intl php8.3-soap

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
systemctl restart php8.3-fpm nginx

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Moodle
echo "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Moodle..."
sudo -u www-data php /var/www/moodle/admin/cli/purge_caches.php

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
echo "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è..."
sudo -u www-data php /var/www/moodle/admin/cli/maintenance.php --disable

echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
EOF

chmod +x /root/moodle-system-update.sh

echo "14. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∫—É—Ä—Å–æ–≤..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π PHP —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
cat > /tmp/setup_frontpage.php << 'PHPEOF'
<?php
define('CLI_SCRIPT', true);
require_once('/var/www/moodle/config.php');

$frontpagesummary = '
<div style="text-align: center; padding: 20px;">
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RTTI LMS</h2>
    <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏–µ–º –†–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∑–∞—Ü–∏–∏</p>
    <hr>
    <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—É—Ä—Å—ã:</h3>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å –∫—É—Ä—Å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∏–∂–µ</p>
</div>
';

set_config('frontpagesummary', $frontpagesummary);
set_config('frontpage', '6,2,7,1,5,3'); // course list, categories, etc

echo "–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞\n";
PHPEOF

# –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç
if sudo -u www-data php /tmp/setup_frontpage.php; then
    echo "‚úÖ –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É"
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f /tmp/setup_frontpage.php

echo "15. –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∞..."
sudo -u www-data php $MOODLE_DIR/admin/cli/purge_caches.php
sudo -u www-data php $MOODLE_DIR/admin/cli/alternative_component_cache.php --rebuild

echo "16. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –ø–æ—Å—Ç-—É—Å—Ç–∞–Ω–æ–≤–∫–µ..."
cat > /root/moodle-post-install-report.txt << EOF
# –û—Ç—á–µ—Ç –æ –ø–æ—Å—Ç-—É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Moodle
# –î–∞—Ç–∞: $(date)
# –°–µ—Ä–≤–µ—Ä: lms.rtti.tj ($(hostname -I | awk '{print $1}'))

=== –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ===

‚úÖ –Ø–∑—ã–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã: —Ä—É—Å—Å–∫–∏–π, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫—É—Ä—Å–æ–≤: —Å–æ–∑–¥–∞–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
‚úÖ –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: Boost
‚úÖ Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: noreply@rtti.tj, support@rtti.tj
‚úÖ –í–µ–±-—Å–µ—Ä–≤–∏—Å—ã: –≤–∫–ª—é—á–µ–Ω—ã
‚úÖ –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: —Å–æ–∑–¥–∞–Ω–æ
‚úÖ –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

=== –°–û–ó–î–ê–ù–ù–´–ï –°–ö–†–ò–ü–¢–´ ===

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: /root/moodle-performance-monitor.sh
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã: /root/moodle-system-update.sh
–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: /root/moodle-backup.sh
–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: /root/moodle-diagnostics.sh

=== –ö–ê–¢–ï–ì–û–†–ò–ò –ö–£–†–°–û–í ===

- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- –¢–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏  
- –Ø–∑—ã–∫–æ–≤—ã–µ –∫—É—Ä—Å—ã
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

=== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –ó–ê–î–ê–ß–ò ===

–ï–∂–µ–º–∏–Ω—É—Ç–Ω–æ: cron –∑–∞–¥–∞—á–∏ Moodle
–ï–∂–µ—á–∞—Å–Ω–æ: –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
–ï–∂–µ–¥–Ω–µ–≤–Ω–æ: –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ (3:00)
–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 4:00)
–ï–∂–µ–º–µ—Å—è—á–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (1 —á–∏—Å–ª–æ 5:00)

=== –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ===

1. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –°–∞–π—Ç > –ù–∞—Å—Ç—Ä–æ–π–∫–∏
3. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–µ –∫—É—Ä—Å—ã –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ–¥ –≤–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
6. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –≤–∞—à–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

=== –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò ===

- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫—É—Ä—Å–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
EOF

echo "17. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤..."
/root/moodle-diagnostics.sh | head -20

echo "18. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."
cat > /root/moodle-admin-guide.txt << EOF
# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Moodle RTTI LMS
# –î–∞—Ç–∞: $(date)

=== –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê ===

1. –í–•–û–î –í –°–ò–°–¢–ï–ú–£
   URL: https://lms.rtti.tj
   –õ–æ–≥–∏–Ω: admin
   –ü–∞—Ä–æ–ª—å: —Å–º. /root/moodle-admin-credentials.txt

2. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–ï–†–í–´–ï –®–ê–ì–ò
   - –°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ > –ê–∫–∫–∞—É–Ω—Ç—ã > –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–∞–π—Ç: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –°–∞–π—Ç > –ù–∞—Å—Ç—Ä–æ–π–∫–∏

3. –ù–ê–°–¢–†–û–ô–ö–ê –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò
   - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞: RTTI Learning Management System
   - –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: RTTI LMS
   - –û–ø–∏—Å–∞–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∏—è –†–¶–¢–ò
   - –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Asia/Dushanbe
   - –°—Ç—Ä–∞–Ω–∞: –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω

=== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ===

1. –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
   –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ > –ê–∫–∫–∞—É–Ω—Ç—ã > –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. –ú–ê–°–°–û–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
   –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ > –ê–∫–∫–∞—É–Ω—Ç—ã > –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

3. –†–û–õ–ò –ò –†–ê–ó–†–ï–®–ï–ù–ò–Ø
   –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ > –†–∞–∑—Ä–µ—à–µ–Ω–∏—è > –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ–ª–∏

=== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–£–†–°–ê–ú–ò ===

1. –°–û–ó–î–ê–ù–ò–ï –ö–£–†–°–ê
   –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ > –ö—É—Ä—Å—ã > –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏

2. –ö–ê–¢–ï–ì–û–†–ò–ò –ö–£–†–°–û–í
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–µ

3. –ó–ê–ü–ò–°–¨ –ù–ê –ö–£–†–°–´
   –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–µ—Ç–æ–¥—ã –∑–∞–ø–∏—Å–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫—É—Ä—Å–∞

=== –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï ===

1. –ú–û–ù–ò–¢–û–†–ò–ù–ì
   –°–∫—Ä–∏–ø—Ç: /root/moodle-performance-monitor.sh

2. –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï
   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ: –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ 2:00
   –†—É—á–Ω–æ–µ: /root/moodle-backup.sh

3. –û–ë–ù–û–í–õ–ï–ù–ò–Ø
   –°–∏—Å—Ç–µ–º–∞: /root/moodle-system-update.sh
   Moodle: /root/update-moodle.sh

4. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê
   –ü—Ä–æ–≤–µ—Ä–∫–∞: /root/moodle-diagnostics.sh

=== –í–ê–ñ–ù–´–ï –°–°–´–õ–ö–ò ===

–ì–ª–∞–≤–Ω–∞—è: https://lms.rtti.tj
–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: https://lms.rtti.tj/admin/
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: https://lms.rtti.tj/admin/user.php
–ö—É—Ä—Å—ã: https://lms.rtti.tj/course/
–ü–ª–∞–≥–∏–Ω—ã: https://lms.rtti.tj/admin/plugins.php
–û—Ç—á–µ—Ç—ã: https://lms.rtti.tj/admin/reports.php

=== –ü–û–î–î–ï–†–ñ–ö–ê ===

Email: support@rtti.tj
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.moodle.org/
–°–æ–æ–±—â–µ—Å—Ç–≤–æ: https://moodle.org/community/
EOF

echo
echo "üéâ ================================================"
echo "üéâ –ü–û–°–¢-–£–°–¢–ê–ù–û–í–û–ß–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "üéâ ================================================"
echo
echo "‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–Ω—ã"
echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
echo
echo "üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:"
echo "   - –û—Ç—á–µ—Ç: /root/moodle-post-install-report.txt"
echo "   - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: /root/moodle-admin-guide.txt"
echo "   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: /root/moodle-performance-monitor.sh"
echo
echo "üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!"
echo "   URL: https://lms.rtti.tj"
echo "   –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: admin"
echo
echo "üìñ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ /root/moodle-admin-guide.txt"
echo "2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏ —Å–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"
echo "4. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–µ –∫—É—Ä—Å—ã"
echo "5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./10-final-check.sh –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏"
echo
echo "‚úÖ –®–∞–≥ 9 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üìå –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: ./10-final-check.sh"
echo
