#!/bin/bash

# RTTI Moodle - –®–∞–≥ 7: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Moodle
# –°–µ—Ä–≤–µ—Ä: omuzgorpro.tj (92.242.60.172)

echo "=== RTTI Moodle - –®–∞–≥ 7: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Moodle ==="
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ config.php –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"
echo "üìÖ –î–∞—Ç–∞: $(date)"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root"
    exit 1
fi

MOODLE_DIR="/var/www/moodle"
CONFIG_FILE="$MOODLE_DIR/config.php"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -d "$MOODLE_DIR" ]; then
    echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ Moodle –Ω–µ –Ω–∞–π–¥–µ–Ω: $MOODLE_DIR"
    exit 1
fi

if [ ! -f "/root/moodle-db-credentials.txt" ]; then
    echo "‚ùå –§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω: /root/moodle-db-credentials.txt"
    exit 1
fi

if [ ! -f "/root/moodle-redis-credentials.txt" ]; then
    echo "‚ùå –§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ Redis –Ω–µ –Ω–∞–π–¥–µ–Ω: /root/moodle-redis-credentials.txt"
    exit 1
fi

echo "1. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
DB_PASSWORD=$(grep "–ü–∞—Ä–æ–ª—å:" /root/moodle-db-credentials.txt | awk '{print $2}')
if [ -z "$DB_PASSWORD" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
    exit 1
fi

echo "2. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis..."
REDIS_PASSWORD=$(grep "–ü–∞—Ä–æ–ª—å:" /root/moodle-redis-credentials.txt | awk '{print $2}')
if [ -z "$REDIS_PASSWORD" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å Redis"
    exit 1
fi

echo "3. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ config.php..."
if [ -f "$CONFIG_FILE" ]; then
    cp $CONFIG_FILE ${CONFIG_FILE}.backup.$(date +%Y%m%d-%H%M%S)
fi

echo "4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Moodle..."
cat > $CONFIG_FILE << EOF
<?php  
// Moodle configuration file
// Generated: $(date)
// Server: omuzgorpro.tj ($(hostname -I | awk '{print $1}'))

unset(\$CFG);
global \$CFG;
\$CFG = new stdClass();

//=========================================================================
// 1. DATABASE SETUP
//=========================================================================
\$CFG->dbtype    = 'pgsql';
\$CFG->dblibrary = 'native';
\$CFG->dbhost    = 'localhost';
\$CFG->dbname    = 'moodle';
\$CFG->dbuser    = 'moodleuser';
\$CFG->dbpass    = '$DB_PASSWORD';
\$CFG->prefix    = 'mdl_';
\$CFG->dboptions = array(
    'dbpersist' => 0,
    'dbport' => 5432,
    'dbsocket' => '',
);

//=========================================================================
// 2. WEB ADDRESSES
//=========================================================================
\$CFG->wwwroot   = 'https://omuzgorpro.tj';

//=========================================================================
// 3. DATA DIRECTORIES
//=========================================================================
\$CFG->dataroot  = '/var/moodledata';
\$CFG->tempdir = '/var/cache/moodle';
\$CFG->cachedir = '/var/cache/moodle';

//=========================================================================
// 4. ADMIN DIRECTORY
//=========================================================================
\$CFG->admin     = 'admin';

// Whether the Moodle router is fully configured (required for Moodle 4.5+)
\$CFG->routerconfigured = false;

//=========================================================================
// 5. SECURITY
//=========================================================================
\$CFG->directorypermissions = 0755;
\$CFG->forcelogin = false;
\$CFG->forceloginforprofiles = true;
\$CFG->opentogoogle = false;
\$CFG->protectusernames = true;

// SSL/HTTPS –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
\$CFG->forcessl = true;

// –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
\$CFG->cookiesecure = true;
\$CFG->cookiehttponly = true;

//=========================================================================
// 6. PERFORMANCE - CACHING
//=========================================================================
// Redis –¥–ª—è —Å–µ—Å—Å–∏–π
\$CFG->session_handler_class = '\core\session\redis';
\$CFG->session_redis_host = '127.0.0.1';
\$CFG->session_redis_port = 6379;
\$CFG->session_redis_auth = '$REDIS_PASSWORD';
\$CFG->session_redis_database = 0;
\$CFG->session_redis_acquire_lock_timeout = 120;
\$CFG->session_redis_lock_expire = 7200;

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis
\$CFG->cache_stores = array(
    'redis_cache' => array(
        'plugin' => 'redis',
        'configuration' => array(
            'server' => '127.0.0.1:6379',
            'password' => '$REDIS_PASSWORD',
            'prefix' => 'mdl_',
            'serializer' => Redis::SERIALIZER_PHP,
            'compressor' => Redis::COMPRESSION_NONE,
        ),
        'features' => Redis::SERIALIZER_PHP,
    ),
);

//=========================================================================
// 7. PERFORMANCE - GENERAL
//=========================================================================
\$CFG->enablecompletion = true;
\$CFG->completiondefault = true;

// –°–∂–∞—Ç–∏–µ
\$CFG->enablegzip = true;
\$CFG->jsrev = 1;
\$CFG->cssrev = 1;

// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
\$CFG->cachetemplates = true;
\$CFG->cachejs = true;

//=========================================================================
// 8. FILE UPLOADS
//=========================================================================
\$CFG->maxbytes = 104857600; // 100MB

//=========================================================================
// 9. EMAIL SETTINGS
//=========================================================================
\$CFG->smtphosts = 'localhost';
\$CFG->smtpuser = '';
\$CFG->smtppass = '';
\$CFG->smtpsecure = '';
\$CFG->smtpautotls = false;
\$CFG->noreplyaddress = 'noreply@omuzgorpro.tj';
\$CFG->supportemail = 'support@omuzgorpro.tj';

//=========================================================================
// 10. LOGGING
//=========================================================================
\$CFG->log_manager = '\core\log\manager';
\$CFG->log_stores = array(
    '\core\log\sql_reader' => array(
        'logformat' => 'standard',
        'buffersize' => 50,
        'logguests' => 1,
        'jsonformat' => 0,
    )
);

//=========================================================================
// 11. BACKUP SETTINGS
//=========================================================================
\$CFG->backup_auto_active = true;
\$CFG->backup_auto_weekdays = '0111110'; // Monday to Friday
\$CFG->backup_auto_hour = 2;
\$CFG->backup_auto_minute = 0;
\$CFG->backup_auto_storage = 0; // Course backup area
\$CFG->backup_auto_destination = '/var/moodledata/backup';
\$CFG->backup_auto_keep = 2;

//=========================================================================
// 12. LOCALIZATION
//=========================================================================
\$CFG->lang = 'ru';
\$CFG->timezone = 'Asia/Dushanbe';
\$CFG->country = 'TJ';

//=========================================================================
// 13. DEBUGGING (for production set to 0)
//=========================================================================
\$CFG->debug = 0;
\$CFG->debugdisplay = 0;
\$CFG->debugdeveloper = false;

//=========================================================================
// 14. MAINTENANCE
//=========================================================================
// \$CFG->maintenance_enabled = true;
// \$CFG->maintenance_message = '–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.';

//=========================================================================
// 15. CUSTOM SETTINGS
//=========================================================================
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è RTTI
\$CFG->theme = 'boost';
\$CFG->enableblogs = false;
\$CFG->enablerssfeeds = false;
\$CFG->enablewebservices = true;

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
\$CFG->passwordpolicy = true;
\$CFG->minpasswordlength = 8;
\$CFG->minpassworddigits = 1;
\$CFG->minpasswordlower = 1;
\$CFG->minpasswordupper = 1;
\$CFG->minpasswordnonalphanum = 1;

//=========================================================================
// LOAD MOODLE
//=========================================================================
require_once(__DIR__ . '/lib/setup.php');

// There is no php closing tag in this file,
// it is intentional because it prevents trailing whitespace problems!
EOF

echo "5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è config.php..."
chown www-data:www-data $CONFIG_FILE
chmod 644 $CONFIG_FILE

echo "6. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
mkdir -p /var/moodledata/backup
chown -R www-data:www-data /var/moodledata/backup
chmod -R 755 /var/moodledata/backup

echo "7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
# –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
sudo -u postgres psql -d moodle -c "SELECT version();" >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: OK"
else
    echo "‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: FAILED"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "1. –ó–∞–ø—É—â–µ–Ω –ª–∏ PostgreSQL: systemctl status postgresql"
    echo "2. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –±–∞–∑–∞ moodle: sudo -u postgres psql -l | grep moodle"
    echo "3. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å moodleuser"
    # –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç, —Ç–∞–∫ –∫–∞–∫ –±–∞–∑–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–∑–∂–µ
fi

echo "8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis..."
# –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis
redis-cli -a "$REDIS_PASSWORD" ping >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis: OK"
else
    echo "‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis: FAILED"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "1. –ó–∞–ø—É—â–µ–Ω –ª–∏ Redis: systemctl status redis-server"
    echo "2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –ø–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ /root/moodle-redis-credentials.txt"
    echo "3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Redis: /etc/redis/redis.conf"
    # –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç, —Ç–∞–∫ –∫–∞–∫ Redis –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ–∑–∂–µ
fi

echo "9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PHP –¥–ª—è Moodle..."
# –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PHP –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Moodle config
echo "PHP –≤–µ—Ä—Å–∏—è: $(php --version | head -1)"
echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ PHP –º–æ–¥—É–ª–∏ –¥–ª—è Moodle:"
php -m | grep -E "(pgsql|redis|curl|xml|mbstring|json|zip|gd|intl)" | head -10

echo "10. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏..."
cat > /root/moodle-diagnostics.sh << EOF
#!/bin/bash
echo "=== Moodle Diagnostics ==="
echo "–î–∞—Ç–∞: \$(date)"
echo

echo "1. PHP –≤–µ—Ä—Å–∏—è:"
php --version | head -1

echo -e "\n2. –°—Ç–∞—Ç—É—Å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:"
systemctl status nginx --no-pager -l | head -3

echo -e "\n3. –°—Ç–∞—Ç—É—Å PHP-FPM:"
systemctl status php8.3-fpm --no-pager -l | head -3

echo -e "\n4. –°—Ç–∞—Ç—É—Å PostgreSQL:"
systemctl status postgresql --no-pager -l | head -3

echo -e "\n5. –°—Ç–∞—Ç—É—Å Redis:"
systemctl status redis-server --no-pager -l | head -3

echo -e "\n6. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:"
sudo -u www-data php -r "
try {
    \\\$pdo = new PDO('pgsql:host=localhost;dbname=moodle', 'moodleuser', '$DB_PASSWORD');
    echo 'Database: OK\n';
} catch (Exception \\\$e) {
    echo 'Database: FAILED\n';
}
"

echo -e "\n7. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis:"
sudo -u www-data php -r "
try {
    \\\$redis = new Redis();
    \\\$redis->connect('127.0.0.1', 6379);
    \\\$redis->auth('$REDIS_PASSWORD');
    echo 'Redis: OK\n';
} catch (Exception \\\$e) {
    echo 'Redis: FAILED\n';
}
"

echo -e "\n8. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:"
ls -la $MOODLE_DIR/ | head -5
echo "..."
ls -la /var/moodledata/ | head -5

echo -e "\n9. –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ:"
df -h | grep -E "(Filesystem|/var|/)"

echo -e "\n10. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:"
openssl x509 -in /etc/letsencrypt/live/omuzgorpro.tj/fullchain.pem -noout -dates 2>/dev/null || echo "SSL: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
EOF

chmod +x /root/moodle-diagnostics.sh

echo "11. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
cat > /root/moodle-config-summary.txt << EOF
# –°–≤–æ–¥–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Moodle
# –î–∞—Ç–∞: $(date)
# –°–µ—Ä–≤–µ—Ä: omuzgorpro.tj ($(hostname -I | awk '{print $1}'))

=== –û–°–ù–û–í–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ ===
URL: https://omuzgorpro.tj
–ö–∞—Ç–∞–ª–æ–≥: $MOODLE_DIR
–î–∞–Ω–Ω—ã–µ: /var/moodledata
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $CONFIG_FILE

=== –ë–ê–ó–ê –î–ê–ù–ù–´–• ===
–¢–∏–ø: PostgreSQL 16
–ë–∞–∑–∞: moodle
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: moodleuser
–•–æ—Å—Ç: localhost

=== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ===
–°–µ—Å—Å–∏–∏: Redis
–ö—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: Redis
–•–æ—Å—Ç Redis: 127.0.0.1:6379

=== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ===
SSL: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
–ó–∞—â–∏—Ç–∞ –ø–∞—Ä–æ–ª–µ–π: –í–∫–ª—é—á–µ–Ω–∞
–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: 8 —Å–∏–º–≤–æ–ª–æ–≤

=== –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ ===
Gzip: –í–∫–ª—é—á–µ–Ω
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤: –í–∫–ª—é—á–µ–Ω–æ
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 100MB

=== –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø ===
–Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π
–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Asia/Dushanbe
–°—Ç—Ä–∞–Ω–∞: –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω

=== –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ===
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ: –í–∫–ª—é—á–µ–Ω–æ
–í—Ä–µ–º—è: 02:00 (–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ü—è—Ç–Ω–∏—Ü–∞)
–•—Ä–∞–Ω–µ–Ω–∏–µ: 2 –∫–æ–ø–∏–∏
–ü—É—Ç—å: /var/moodledata/backup

=== –ö–û–ú–ê–ù–î–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===
–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: /root/moodle-diagnostics.sh
–ü—Ä–æ–≤–µ—Ä–∫–∞ PHP: php -f $MOODLE_DIR/admin/cli/check.php
–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞: sudo -u www-data php $MOODLE_DIR/admin/cli/purge_caches.php
–†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: sudo -u www-data php $MOODLE_DIR/admin/cli/maintenance.php --enable/--disable
EOF

echo "12. –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ PHP..."
rm -f $MOODLE_DIR/phpinfo.php

echo "13. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ config.php:"
php -l $CONFIG_FILE

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å config.php –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ config.php"
    exit 1
fi

echo "14. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ..."
if sudo -u www-data php -f $MOODLE_DIR/version.php >/dev/null 2>&1; then
    echo "‚úÖ Moodle –≥–æ—Ç–æ–≤ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ"
else
    echo "‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"
fi

echo
echo "‚úÖ –®–∞–≥ 7 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üìå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Moodle —Å–æ–∑–¥–∞–Ω–∞: $CONFIG_FILE"
echo "üìå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞: PostgreSQL"
echo "üìå –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ: Redis"
echo "üìå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: /root/moodle-diagnostics.sh"
echo "üìå –°–≤–æ–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: /root/moodle-config-summary.txt"
echo "üìå –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: ./08-install-moodle.sh"
echo
