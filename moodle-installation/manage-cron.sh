#!/bin/bash

# RTTI Moodle - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Cron
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º –∑–∞–¥–∞—á Moodle

echo "=== RTTI Moodle - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Cron ==="
echo "üïê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º –∑–∞–¥–∞—á Moodle"
echo "üìÖ –î–∞—Ç–∞: $(date)"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root"
    exit 1
fi

MOODLE_DIR="/var/www/moodle"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è Moodle
if [ ! -d "$MOODLE_DIR" ]; then
    echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ Moodle –Ω–µ –Ω–∞–π–¥–µ–Ω: $MOODLE_DIR"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é
show_menu() {
    echo "üîß –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    echo "1) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π cron (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    echo "2) –ó–∞–ø—É—Å—Ç–∏—Ç—å cron –æ–¥–∏–Ω —Ä–∞–∑"
    echo "3) –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ cron –ø—Ä–æ—Ü–µ—Å—Å—ã"
    echo "4) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å cron"
    echo "5) –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ cron"
    echo "6) –¢–µ—Å—Ç cron (–±–µ–∑ keep-alive)"
    echo "0) –í—ã—Ö–æ–¥"
    echo
    read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä: " choice
}

# –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ cron
setup_system_cron() {
    echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ cron –¥–ª—è Moodle..."
    
    # –°–æ–∑–¥–∞–µ–º cron —Ñ–∞–π–ª –¥–ª—è Moodle
    cat > /etc/cron.d/moodle << EOF
# Moodle cron job - RTTI Configuration
# –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
* * * * * www-data /usr/bin/php $MOODLE_DIR/admin/cli/cron.php --quiet >/dev/null 2>&1

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
0 */4 * * * www-data /usr/bin/php $MOODLE_DIR/admin/cli/purge_caches.php >/dev/null 2>&1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
0 3 * * * www-data /usr/bin/php $MOODLE_DIR/admin/cli/check_for_updates.php >/dev/null 2>&1
EOF

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    chmod 644 /etc/cron.d/moodle
    chown root:root /etc/cron.d/moodle
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º cron —Å–ª—É–∂–±—É
    systemctl restart cron
    
    echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π cron –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    echo "‚ÑπÔ∏è  Moodle cron –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo "‚ÑπÔ∏è  –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ /var/log/syslog"
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ cron –æ–¥–∏–Ω —Ä–∞–∑
run_cron_once() {
    echo "üèÉ –ó–∞–ø—É—Å–∫ Moodle cron –æ–¥–∏–Ω —Ä–∞–∑..."
    
    echo "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ cron –∑–∞–¥–∞—á..."
    sudo -u www-data php $MOODLE_DIR/admin/cli/cron.php --quiet
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Cron –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è cron"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö cron –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
stop_cron_processes() {
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö Moodle cron –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    
    # –ù–∞–π—Ç–∏ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã cron.php
    CRON_PIDS=$(pgrep -f "cron.php")
    
    if [ -n "$CRON_PIDS" ]; then
        echo "–ù–∞–π–¥–µ–Ω—ã –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ cron –ø—Ä–æ—Ü–µ—Å—Å—ã: $CRON_PIDS"
        
        # –ú—è–≥–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        echo "–ü–æ–ø—ã—Ç–∫–∞ –º—è–≥–∫–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..."
        kill $CRON_PIDS 2>/dev/null
        
        sleep 3
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
        REMAINING_PIDS=$(pgrep -f "cron.php")
        if [ -n "$REMAINING_PIDS" ]; then
            echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
            kill -9 $REMAINING_PIDS 2>/dev/null
        fi
        
        echo "‚úÖ –í—Å–µ cron –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        echo "‚ÑπÔ∏è  –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ cron –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ cron
check_cron_status() {
    echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Moodle cron..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å–ª—É–∂–±—ã cron
    echo "üîß –°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±—ã cron:"
    systemctl is-active cron && echo "‚úÖ –°–ª—É–∂–±–∞ cron –∞–∫—Ç–∏–≤–Ω–∞" || echo "‚ùå –°–ª—É–∂–±–∞ cron –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ cron
    if [ -f "/etc/cron.d/moodle" ]; then
        echo "‚úÖ –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ cron –Ω–∞–π–¥–µ–Ω: /etc/cron.d/moodle"
        echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
        cat /etc/cron.d/moodle
    else
        echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ cron –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    CRON_PIDS=$(pgrep -f "cron.php")
    if [ -n "$CRON_PIDS" ]; then
        echo "üèÉ –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ cron –ø—Ä–æ—Ü–µ—Å—Å—ã:"
        ps aux | grep cron.php | grep -v grep
    else
        echo "‚ÑπÔ∏è  –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö cron –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    fi
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö
    echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ cron –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ª–æ–≥–µ:"
    journalctl -u cron --no-pager -n 5
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
show_cron_logs() {
    echo "üìù –õ–æ–≥–∏ Moodle cron..."
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ª–æ–≥–∞
    echo "üîç –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ª–æ–≥–∞:"
    journalctl -u cron --no-pager -n 20 | grep -i moodle || echo "–ó–∞–ø–∏—Å–∏ Moodle –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ª–æ–≥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥-—Ñ–∞–π–ª Moodle, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    MOODLE_LOG="$MOODLE_DIR/../moodledata/moodle.log"
    if [ -f "$MOODLE_LOG" ]; then
        echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ª–æ–≥–∞ Moodle:"
        tail -20 "$MOODLE_LOG"
    fi
}

# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
test_cron() {
    echo "üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ Moodle cron..."
    
    echo "–ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º (–±–µ–∑ keep-alive —Ä–µ–∂–∏–º–∞)..."
    sudo -u www-data php $MOODLE_DIR/admin/cli/cron.php --verbose
    
    echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
while true; do
    echo
    show_menu
    
    case $choice in
        1)
            setup_system_cron
            ;;
        2)
            run_cron_once
            ;;
        3)
            stop_cron_processes
            ;;
        4)
            check_cron_status
            ;;
        5)
            show_cron_logs
            ;;
        6)
            test_cron
            ;;
        0)
            echo "üëã –í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            ;;
    esac
    
    echo
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
done
