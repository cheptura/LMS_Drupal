#!/bin/bash

# –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –û–°–¢–ê–ù–û–í–ö–ê MOODLE CRON
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—Å–ª–∏ cron –∑–∞–≤–∏—Å–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –û–°–¢–ê–ù–û–í–ö–ê MOODLE CRON üö®"
echo "=================================================="

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
echo "üîç –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö cron –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
CRON_PROCESSES=$(ps aux | grep -E "(cron\.php|cli/cron)" | grep -v grep)

if [ -n "$CRON_PROCESSES" ]; then
    echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    echo "$CRON_PROCESSES"
    echo
    
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö cron –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    
    # –ú—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    pkill -f "cron.php" 2>/dev/null
    pkill -f "cli/cron" 2>/dev/null
    
    sleep 2
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    pkill -9 -f "cron.php" 2>/dev/null
    pkill -9 -f "cli/cron" 2>/dev/null
    
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ÑπÔ∏è  –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ cron –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –û—Ç–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π cron –≤—Ä–µ–º–µ–Ω–Ω–æ
if [ -f "/etc/cron.d/moodle" ]; then
    echo "üîß –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ cron..."
    mv /etc/cron.d/moodle /etc/cron.d/moodle.disabled 2>/dev/null
    systemctl restart cron 2>/dev/null
    echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π cron –æ—Ç–∫–ª—é—á–µ–Ω"
fi

echo
echo "üéØ CRON –û–°–¢–ê–ù–û–í–õ–ï–ù –£–°–ü–ï–®–ù–û!"
echo "=================================================="
echo "‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É Moodle"
echo "üîÑ –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è cron:"
echo "   sudo mv /etc/cron.d/moodle.disabled /etc/cron.d/moodle"
echo "   sudo systemctl restart cron"
echo "=================================================="
