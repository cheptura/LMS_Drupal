#!/bin/bash

# RTTI Drupal - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# –°–µ—Ä–≤–µ—Ä: storage.omuzgorpro.tj (92.242.61.204)

echo "=== RTTI Drupal - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ==="
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º Nginx, PHP OPcache –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
echo "üìÖ –î–∞—Ç–∞: $(date)"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root"
    exit 1
fi

echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PHP OPcache..."
if php -m | grep -q opcache; then
    echo "   ‚úÖ OPcache —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "   üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PHP OPcache..."
    apt update
    apt install -y php8.3-opcache
fi

echo "2. –í–∫–ª—é—á–µ–Ω–∏–µ OPcache –≤ PHP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
# –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ OPcache –≤–∫–ª—é—á–µ–Ω –≤ php.ini
if ! grep -q "opcache.enable=1" /etc/php/8.3/fpm/php.ini; then
    echo "   üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OPcache –≤ FPM..."
    cat >> /etc/php/8.3/fpm/php.ini << 'EOF'

; OPcache settings for Drupal
opcache.enable=1
opcache.memory_consumption=256
opcache.max_accelerated_files=10000
opcache.revalidate_freq=2
opcache.save_comments=1
opcache.enable_file_override=1
opcache.validate_timestamps=1
EOF
fi

if ! grep -q "opcache.enable=1" /etc/php/8.3/cli/php.ini; then
    echo "   üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OPcache –≤ CLI..."
    cat >> /etc/php/8.3/cli/php.ini << 'EOF'

; OPcache settings for Drupal
opcache.enable=1
opcache.enable_cli=1
opcache.memory_consumption=256
opcache.max_accelerated_files=10000
opcache.revalidate_freq=2
opcache.save_comments=1
opcache.enable_file_override=1
opcache.validate_timestamps=1
EOF
fi

echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PHP-FPM –ø—É–ª–∞..."
if [ ! -f "/etc/php/8.3/fpm/pool.d/drupal.conf" ]; then
    echo "   üîß –°–æ–∑–¥–∞–Ω–∏–µ PHP-FPM –ø—É–ª–∞ –¥–ª—è Drupal..."
    cat > /etc/php/8.3/fpm/pool.d/drupal.conf << 'EOF'
[drupal]
user = www-data
group = www-data

listen = /run/php/php8.3-fpm-drupal.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

pm = dynamic
pm.max_children = 20
pm.start_servers = 4
pm.min_spare_servers = 2
pm.max_spare_servers = 8
pm.max_requests = 1000

; Security
security.limit_extensions = .php

; Logging
catch_workers_output = yes
php_admin_value[error_log] = /var/log/php8.3-fpm-drupal.log
php_admin_flag[log_errors] = on

; Environment variables
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; PHP values for Drupal
php_admin_value[memory_limit] = 512M
php_admin_value[max_execution_time] = 300
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M
php_admin_value[max_input_vars] = 3000
EOF
else
    echo "   ‚úÖ PHP-FPM –ø—É–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
if [ ! -f "/etc/nginx/sites-available/drupal-default" ]; then
    echo "   üîß –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx –¥–ª—è Drupal..."
    cat > /etc/nginx/sites-available/drupal-default << 'EOF'
server {
    listen 80;
    server_name storage.omuzgorpro.tj www.storage.omuzgorpro.tj;
    
    root /var/www/drupal/web;
    index index.php index.html;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # File upload size
    client_max_body_size 100M;
    
    # Drupal specific configurations
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
    
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }
    
    # Deny access to configuration files
    location ~ \..*/.*\.php$ {
        return 403;
    }
    
    location ~ ^/sites/.*/private/ {
        return 403;
    }
    
    location ~ ^/sites/[^/]+/files/.*\.php$ {
        deny all;
    }
    
    location ~* ^/.well-known/ {
        allow all;
    }
    
    location ~ (^|/)\. {
        return 403;
    }
    
    location / {
        try_files $uri /index.php?$query_string;
    }
    
    location @rewrite {
        rewrite ^/(.*)$ /index.php?q=$1;
    }
    
    # PHP processing - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö PHP —Ñ–∞–π–ª–æ–≤
    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_index index.php;
        fastcgi_pass unix:/run/php/php8.3-fpm-drupal.sock;
        include fastcgi_params;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        fastcgi_intercept_errors on;
        fastcgi_ignore_client_abort off;
        fastcgi_connect_timeout 60;
        fastcgi_send_timeout 180;
        fastcgi_read_timeout 180;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
    }
    
    # Static files caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        log_not_found off;
    }
    
    # Deny access to vendor directory
    location ^~ /vendor/ {
        deny all;
        return 403;
    }
    
    # Deny access to composer files
    location ~* composer\.(json|lock)$ {
        deny all;
        return 403;
    }
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml
        application/xml+rss;
}
EOF
else
    echo "   ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

echo "5. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Drupal..."
mkdir -p /var/www/drupal/web
chown -R www-data:www-data /var/www/drupal

echo "6. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞ Nginx..."
# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∞–π—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if [ -L /etc/nginx/sites-enabled/default ]; then
    echo "   üîå –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∞–π—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é..."
    unlink /etc/nginx/sites-enabled/default
fi

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Drupal
if [ ! -L /etc/nginx/sites-enabled/drupal-default ]; then
    echo "   üîó –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Drupal..."
    ln -sf /etc/nginx/sites-available/drupal-default /etc/nginx/sites-enabled/
fi

echo "7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
if nginx -t; then
    echo "   ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx"
    echo "   üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:"
    nginx -t
    exit 1
fi

echo "8. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
echo "   üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PHP-FPM..."
systemctl restart php8.3-fpm
if systemctl is-active --quiet php8.3-fpm; then
    echo "   ‚úÖ PHP-FPM –∞–∫—Ç–∏–≤–µ–Ω"
    systemctl enable php8.3-fpm
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ PHP-FPM"
    systemctl status php8.3-fpm --no-pager
    exit 1
fi

echo "   üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
systemctl restart nginx
if systemctl is-active --quiet nginx; then
    echo "   ‚úÖ Nginx –∞–∫—Ç–∏–≤–µ–Ω"
    systemctl enable nginx
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Nginx"
    systemctl status nginx --no-pager
    exit 1
fi

echo "9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
echo "   üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤:"
if netstat -tlnp | grep ":80 "; then
    echo "   ‚úÖ –ü–æ—Ä—Ç 80 –æ—Ç–∫—Ä—ã—Ç"
else
    echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 80 –Ω–µ –æ—Ç–∫—Ä—ã—Ç"
fi

if netstat -tlnp | grep ":443 "; then
    echo "   ‚úÖ –ü–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç"
else
    echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 443 –Ω–µ –æ—Ç–∫—Ä—ã—Ç (–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)"
fi

echo "10. –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP –º–æ–¥—É–ª–µ–π..."
echo "   üìã –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ PHP –º–æ–¥—É–ª–∏:"
php -m | grep -E "(opcache|pgsql|gd|curl|zip|xml|mbstring)" | while read module; do
    echo "   ‚úÖ $module"
done

echo "11. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
cat > /var/www/drupal/web/phpinfo.php << 'EOF'
<?php
echo "<h1>RTTI Drupal - –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP</h1>";
echo "<h2>–í–µ—Ä—Å–∏—è PHP:</h2>";
echo "<p>" . phpversion() . "</p>";

echo "<h2>–í–∞–∂–Ω—ã–µ –º–æ–¥—É–ª–∏:</h2>";
$modules = ['pgsql', 'gd', 'curl', 'zip', 'xml', 'mbstring', 'opcache'];
foreach ($modules as $module) {
    $status = extension_loaded($module) ? "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" : "‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
    echo "<p><strong>$module:</strong> $status</p>";
}

echo "<h2>OPcache Status:</h2>";
if (extension_loaded('opcache')) {
    $opcache_status = opcache_get_status();
    if ($opcache_status !== false) {
        echo "<p>‚úÖ OPcache –∞–∫—Ç–∏–≤–µ–Ω</p>";
        echo "<p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–∞–º—è—Ç–∏: " . round($opcache_status['memory_usage']['used_memory'] / 1024 / 1024, 2) . " MB</p>";
        echo "<p>–ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: " . $opcache_status['opcache_statistics']['num_cached_scripts'] . "</p>";
    } else {
        echo "<p>‚ö†Ô∏è OPcache —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</p>";
    }
} else {
    echo "<p>‚ùå OPcache –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</p>";
}

echo "<h2>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ Drupal 11:</h2>";
$ready = extension_loaded('pgsql') && extension_loaded('gd') && extension_loaded('curl');
echo $ready ? "<p>‚úÖ –ì–æ—Ç–æ–≤</p>" : "<p>‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</p>";
?>
EOF

chown www-data:www-data /var/www/drupal/web/phpinfo.php

echo
echo "üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´ –£–°–ü–ï–®–ù–û!"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:"
echo "   ‚úÖ PHP OPcache: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
echo "   ‚úÖ PHP-FPM –ø—É–ª: —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω"
echo "   ‚úÖ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
echo "   ‚úÖ –°–µ—Ä–≤–∏—Å—ã: –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –∏ –≤–∫–ª—é—á–µ–Ω—ã"
echo
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
echo "   Nginx: $(systemctl is-active nginx)"
echo "   PHP-FPM: $(systemctl is-active php8.3-fpm)"
echo
echo "üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
echo "   HTTP: http://storage.omuzgorpro.tj/phpinfo.php"
echo "   –ï—Å–ª–∏ IP –ª–æ–∫–∞–ª—å–Ω—ã–π: http://192.168.0.163/phpinfo.php"
echo
echo "üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "   2. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω SSL, –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ./05-configure-ssl.sh"
echo "   3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É Drupal: ./06-install-drupal.sh"
echo
echo "‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–í–ï–†–®–ï–ù–´!"
