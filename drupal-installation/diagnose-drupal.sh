#!/bin/bash

# RTTI Drupal Diagnostics Script
# –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Drupal —Å–∏—Å—Ç–µ–º—ã

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                         Drupal Diagnostics Script                           ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo

echo "üìÖ –î–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: $(date)"
echo "üñ•Ô∏è  –°–µ—Ä–≤–µ—Ä: $(hostname)"
echo "üåê IP –∞–¥—Ä–µ—Å: $(hostname -I | awk '{print $1}')"
echo

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DRUPAL_DIR="/var/www/html/drupal"
FILES_DIR="/var/drupaldata"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è Drupal
if [ ! -d "$DRUPAL_DIR" ]; then
    echo "‚ùå Drupal –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $DRUPAL_DIR"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Drupal
echo "üìö –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û DRUPAL"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

if [ -f "$DRUPAL_DIR/core/lib/Drupal.php" ]; then
    cd $DRUPAL_DIR
    DRUPAL_VERSION=$(sudo -u www-data vendor/bin/drush status --field=drupal-version 2>/dev/null || echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    DB_STATUS=$(sudo -u www-data vendor/bin/drush status --field=db-status 2>/dev/null || echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    BOOTSTRAP=$(sudo -u www-data vendor/bin/drush status --field=bootstrap 2>/dev/null || echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    
    echo "üìã –í–µ—Ä—Å–∏—è Drupal: $DRUPAL_VERSION"
    echo "üóÑÔ∏è  –°—Ç–∞—Ç—É—Å –ë–î: $DB_STATUS"
    echo "üöÄ –ó–∞–≥—Ä—É–∑–∫–∞: $BOOTSTRAP"
else
    echo "‚ùå –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã Drupal –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è Drupal: $DRUPAL_DIR"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ñ–∞–π–ª–æ–≤: $FILES_DIR"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "‚öôÔ∏è  –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø DRUPAL"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

if [ -f "$DRUPAL_DIR/sites/default/settings.php" ]; then
    echo "‚úÖ –§–∞–π–ª settings.php –Ω–∞–π–¥–µ–Ω"
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î
    if grep -q "database.*=>" "$DRUPAL_DIR/sites/default/settings.php"; then
        DB_NAME=$(grep "database.*=>" "$DRUPAL_DIR/sites/default/settings.php" | head -1 | cut -d"'" -f2)
        DB_HOST=$(grep "host.*=>" "$DRUPAL_DIR/sites/default/settings.php" | head -1 | cut -d"'" -f2)
        DB_USER=$(grep "username.*=>" "$DRUPAL_DIR/sites/default/settings.php" | head -1 | cut -d"'" -f2)
        
        echo "üóÑÔ∏è  –ò–º—è –ë–î: $DB_NAME"
        echo "üåê –•–æ—Å—Ç –ë–î: $DB_HOST"
        echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î: $DB_USER"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ trusted hosts
    if grep -q "trusted_host_patterns" "$DRUPAL_DIR/sites/default/settings.php"; then
        echo "‚úÖ Trusted host patterns: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    else
        echo "‚ö†Ô∏è  Trusted host patterns: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    fi
else
    echo "‚ùå –§–∞–π–ª settings.php –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ composer.json
if [ -f "$DRUPAL_DIR/composer.json" ]; then
    echo "‚úÖ Composer.json –Ω–∞–π–¥–µ–Ω"
    if [ -f "$DRUPAL_DIR/composer.lock" ]; then
        echo "‚úÖ Composer.lock –Ω–∞–π–¥–µ–Ω"
    else
        echo "‚ö†Ô∏è  Composer.lock –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
    fi
else
    echo "‚ùå Composer.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ü–†–ê–í–ê –î–û–°–¢–£–ü–ê"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

DRUPAL_OWNER=$(stat -c '%U:%G' $DRUPAL_DIR)
DRUPAL_PERMS=$(stat -c '%a' $DRUPAL_DIR)
echo "üìÇ Drupal –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DRUPAL_OWNER ($DRUPAL_PERMS)"

if [ -f "$DRUPAL_DIR/sites/default/settings.php" ]; then
    SETTINGS_OWNER=$(stat -c '%U:%G' "$DRUPAL_DIR/sites/default/settings.php")
    SETTINGS_PERMS=$(stat -c '%a' "$DRUPAL_DIR/sites/default/settings.php")
    echo "‚öôÔ∏è  Settings.php: $SETTINGS_OWNER ($SETTINGS_PERMS)"
fi

if [ -d "$DRUPAL_DIR/sites/default/files" ]; then
    FILES_OWNER=$(stat -c '%U:%G' "$DRUPAL_DIR/sites/default/files")
    FILES_PERMS=$(stat -c '%a' "$DRUPAL_DIR/sites/default/files")
    echo "üìÅ Files –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $FILES_OWNER ($FILES_PERMS)"
fi

if [ -d "$FILES_DIR" ]; then
    DATA_OWNER=$(stat -c '%U:%G' $FILES_DIR)
    DATA_PERMS=$(stat -c '%a' $FILES_DIR)
    echo "üìÅ –î–∞–Ω–Ω—ã–µ Drupal: $DATA_OWNER ($DATA_PERMS)"
else
    echo "‚ÑπÔ∏è  –í–Ω–µ—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π
echo "üß© –ú–û–î–£–õ–ò DRUPAL"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

if [ -d "$DRUPAL_DIR" ]; then
    cd $DRUPAL_DIR
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥—É–ª–µ–π
    ENABLED_MODULES=$(sudo -u www-data vendor/bin/drush pml --status=enabled --no-core --format=list 2>/dev/null | wc -l)
    echo "‚úÖ –í–∫–ª—é—á–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π: $ENABLED_MODULES"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–æ–¥—É–ª–µ–π
    CRITICAL_MODULES=("node" "user" "system" "field" "text")
    for module in "${CRITICAL_MODULES[@]}"; do
        if sudo -u www-data vendor/bin/drush pml --status=enabled --format=list 2>/dev/null | grep -q "^$module$"; then
            echo "‚úÖ –ú–æ–¥—É–ª—å $module: –í–∫–ª—é—á–µ–Ω"
        else
            echo "‚ùå –ú–æ–¥—É–ª—å $module: –ù–µ –≤–∫–ª—é—á–µ–Ω"
        fi
    done
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    UPDATES=$(sudo -u www-data vendor/bin/drush ups --format=list 2>/dev/null | wc -l)
    if [ $UPDATES -gt 0 ]; then
        echo "üì¶ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: $UPDATES"
    else
        echo "‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã"
    fi
fi
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è  –ë–ê–ó–ê –î–ê–ù–ù–´–•"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

if [ ! -z "$DB_NAME" ] && [ ! -z "$DB_USER" ]; then
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
    if sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
        echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö '$DB_NAME' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        
        # –†–∞–∑–º–µ—Ä –ë–î
        DB_SIZE=$(sudo -u postgres psql -c "SELECT pg_size_pretty(pg_database_size('$DB_NAME'));" -t | xargs)
        echo "üìä –†–∞–∑–º–µ—Ä –ë–î: $DB_SIZE"
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü
        TABLE_COUNT=$(sudo -u postgres psql -d "$DB_NAME" -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';" -t | xargs)
        echo "üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü: $TABLE_COUNT"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü Drupal
        CORE_TABLES=("config" "users" "node" "cache_default")
        for table in "${CORE_TABLES[@]}"; do
            if sudo -u postgres psql -d "$DB_NAME" -c "\dt $table" | grep -q "$table"; then
                echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ $table: –ù–∞–π–¥–µ–Ω–∞"
            else
                echo "‚ùå –¢–∞–±–ª–∏—Ü–∞ $table: –ù–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi
        done
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ Drush
        if [ -d "$DRUPAL_DIR" ]; then
            cd $DRUPAL_DIR
            DB_UPDATES=$(sudo -u www-data vendor/bin/drush updatedb --no-cache-clear --dry-run 2>/dev/null | grep "No pending updates" && echo "0" || echo "–ï—Å—Ç—å")
            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î: $DB_UPDATES"
        fi
    else
        echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö '$DB_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
else
    echo "‚ùå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã"
fi
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
echo "üåê –í–ï–ë-–°–ï–†–í–ï–†"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

if systemctl is-active --quiet nginx; then
    echo "‚úÖ Nginx: –ê–∫—Ç–∏–≤–µ–Ω"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
    if nginx -t &>/dev/null; then
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è"
    else
        echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx: –û—à–∏–±–∫–∏ –Ω–∞–π–¥–µ–Ω—ã"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞
    if [ -f "/etc/nginx/sites-enabled/drupal" ] || [ -f "/etc/nginx/sites-enabled/library" ]; then
        echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç: –ù–∞—Å—Ç—Ä–æ–µ–Ω"
    else
        echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç: –ù–µ –Ω–∞–π–¥–µ–Ω"
    fi
else
    echo "‚ùå Nginx: –ù–µ –∞–∫—Ç–∏–≤–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP
PHP_VERSION=$(php -v | head -1 | awk '{print $2}')
echo "üêò PHP –≤–µ—Ä—Å–∏—è: $PHP_VERSION"

if systemctl is-active --quiet php8.3-fpm; then
    echo "‚úÖ PHP-FPM: –ê–∫—Ç–∏–≤–µ–Ω"
else
    echo "‚ùå PHP-FPM: –ù–µ –∞–∫—Ç–∏–≤–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π PHP
REQUIRED_EXTENSIONS=("pdo" "pdo_pgsql" "gd" "curl" "mbstring" "xml" "zip" "opcache")
echo "üîå PHP —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:"
for ext in "${REQUIRED_EXTENSIONS[@]}"; do
    if php -m | grep -q "$ext"; then
        echo "   ‚úÖ $ext"
    else
        echo "   ‚ùå $ext"
    fi
done
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
echo "‚ö° –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
DISK_USAGE=$(df $DRUPAL_DIR | awk 'NR==2 {print $5}')
echo "üíΩ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: $DISK_USAGE"

# –†–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Drupal
DRUPAL_SIZE=$(du -sh $DRUPAL_DIR | awk '{print $1}')
echo "üìÇ –†–∞–∑–º–µ—Ä Drupal: $DRUPAL_SIZE"

if [ -d "$DRUPAL_DIR/sites/default/files" ]; then
    FILES_SIZE=$(du -sh $DRUPAL_DIR/sites/default/files | awk '{print $1}')
    echo "üìÅ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤: $FILES_SIZE"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
if [ -d "$DRUPAL_DIR" ]; then
    cd $DRUPAL_DIR
    CACHE_STATUS=$(sudo -u www-data vendor/bin/drush status --field=theme 2>/dev/null || echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    echo "üóÑÔ∏è  –°—Ç–∞—Ç—É—Å –∫—ç—à–∞: $CACHE_STATUS"
fi
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
echo "üõ°Ô∏è  –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
if [ -d "$DRUPAL_DIR" ]; then
    cd $DRUPAL_DIR
    MAINTENANCE=$(sudo -u www-data vendor/bin/drush state:get system.maintenance_mode 2>/dev/null || echo "0")
    if [ "$MAINTENANCE" = "1" ]; then
        echo "‚ö†Ô∏è  –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: –í–∫–ª—é—á–µ–Ω"
    else
        echo "‚úÖ –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: –í—ã–∫–ª—é—á–µ–Ω"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ settings.php
if [ -f "$DRUPAL_DIR/sites/default/settings.php" ]; then
    SETTINGS_PERMS=$(stat -c '%a' "$DRUPAL_DIR/sites/default/settings.php")
    if [ "$SETTINGS_PERMS" = "444" ] || [ "$SETTINGS_PERMS" = "644" ]; then
        echo "‚úÖ –ü—Ä–∞–≤–∞ settings.php: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ ($SETTINGS_PERMS)"
    else
        echo "‚ö†Ô∏è  –ü—Ä–∞–≤–∞ settings.php: –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ ($SETTINGS_PERMS)"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL
SITE_URL=$(grep "base_url" "$DRUPAL_DIR/sites/default/settings.php" 2>/dev/null | cut -d"'" -f2 || echo "")
if [[ "$SITE_URL" == https://* ]]; then
    DOMAIN=$(echo "$SITE_URL" | sed 's|https://||' | sed 's|/.*||')
    if [ -f "/etc/letsencrypt/live/$DOMAIN/cert.pem" ]; then
        echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –ù–∞–π–¥–µ–Ω –¥–ª—è $DOMAIN"
    else
        echo "‚ùå SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –ù–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è $DOMAIN"
    fi
else
    echo "‚ÑπÔ∏è  SSL: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi
echo

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

if [ -d "$DRUPAL_DIR" ]; then
    cd $DRUPAL_DIR
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    SECURITY_UPDATES=$(sudo -u www-data vendor/bin/drush ups --security-only --format=list 2>/dev/null | wc -l)
    if [ $SECURITY_UPDATES -gt 0 ]; then
        echo "üö® –ö—Ä–∏—Ç–∏—á–Ω–æ: –î–æ—Å—Ç—É–ø–Ω–æ $SECURITY_UPDATES –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ: vendor/bin/drush ups --security-only"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    echo "üßπ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:"
    echo "   vendor/bin/drush cache:rebuild"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ cron
    CRON_LAST=$(sudo -u www-data vendor/bin/drush state:get system.cron_last 2>/dev/null || echo "0")
    if [ "$CRON_LAST" != "0" ]; then
        CRON_AGE=$(($(date +%s) - $CRON_LAST))
        if [ $CRON_AGE -gt 86400 ]; then
            echo "‚ö†Ô∏è  Cron –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫"
            echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ: vendor/bin/drush cron"
        fi
    fi
fi

echo
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                           –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞                             ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo
echo "üìã –î–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   cd $DRUPAL_DIR"
echo "   sudo -u www-data vendor/bin/drush status"
echo "   sudo -u www-data vendor/bin/drush requirements"
