#!/bin/bash

# RTTI Drupal - –®–∞–≥ 6: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drupal 11
# –°–µ—Ä–≤–µ—Ä: storage.omuzgorpro.tj (92.242.61.204)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Composer
export COMPOSER_ALLOW_SUPERUSER=1
export COMPOSER_MEMORY_LIMIT=-1

echo "=== RTTI Drupal - –®–∞–≥ 6: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drupal 11 ==="
echo "üìö –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"
echo "üìÖ –î–∞—Ç–∞: $(date)"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root"
    exit 1
fi

DRUPAL_DIR="/var/www/drupal"
BACKUP_DIR="/root/drupal-backup-$(date +%Y%m%d-%H%M%S)"

echo "1. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –µ—Å–ª–∏ Drupal —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω..."
if [ -d "$DRUPAL_DIR" ] && [ -f "$DRUPAL_DIR/composer.json" ]; then
    echo "–ù–∞–π–¥–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Drupal, —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    mkdir -p $BACKUP_DIR
    cp -r $DRUPAL_DIR $BACKUP_DIR/
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_DIR"
fi

echo "2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è Drupal..."
mkdir -p $DRUPAL_DIR
cd $DRUPAL_DIR

# –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
if [ "$(ls -A $DRUPAL_DIR)" ]; then
    echo "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤..."
    rm -rf $DRUPAL_DIR/*
    rm -rf $DRUPAL_DIR/.*  2>/dev/null || true
fi

echo "3. –°–æ–∑–¥–∞–Ω–∏–µ Drupal –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ Composer..."
echo "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ Drupal 11..."

# –°–æ–∑–¥–∞–Ω–∏–µ –∫—ç—à-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è Composer —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
mkdir -p /var/www/.cache/composer
chown -R www-data:www-data /var/www/.cache
chmod -R 755 /var/www/.cache

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ COMPOSER_ALLOW_SUPERUSER –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ–¥ root –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
export COMPOSER_ALLOW_SUPERUSER=1

# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ Drupal —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º composer
sudo -u www-data composer create-project drupal/recommended-project:^11.0 . --no-interaction --prefer-dist

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ Drupal —á–µ—Ä–µ–∑ Composer"
    echo "–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏..."
    
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Composer
    sudo -u www-data composer clear-cache
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
    sudo -u www-data COMPOSER_ALLOW_SUPERUSER=1 composer create-project drupal/recommended-project . --no-interaction
    
    if [ $? -ne 0 ]; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç Drupal"
        exit 1
    fi
fi

echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Drupal..."
if [ ! -f "$DRUPAL_DIR/web/index.php" ]; then
    echo "‚ùå –§–∞–π–ª—ã Drupal –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    exit 1
fi

echo "5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ Drupal..."
DRUPAL_VERSION=$(sudo -u www-data php web/core/scripts/drupal version 2>/dev/null || echo "Drupal 11.x")
echo "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è: $DRUPAL_VERSION"

echo "5.1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drush..."
echo "üîç –û–¢–õ–ê–î–ö–ê: –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Drush..."
cd $DRUPAL_DIR

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
echo "   –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ composer.json..."

if [ -f "composer.json" ]; then
    echo "‚úÖ composer.json –Ω–∞–π–¥–µ–Ω"
    echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ composer.json (–ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫):"
    head -10 composer.json
else
    echo "‚ùå composer.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
    ls -la
    exit 1
fi

echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vendor/bin –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
ls -la vendor/bin/ 2>/dev/null || echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è vendor/bin –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

echo "   üöÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Drush —á–µ—Ä–µ–∑ Composer..."
sudo -u www-data composer require drush/drush --no-interaction --verbose

COMPOSER_RESULT=$?
echo "   üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Composer: $COMPOSER_RESULT"

if [ $COMPOSER_RESULT -ne 0 ]; then
    echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Drush, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã..."
    
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Composer
    echo "   üßπ –û—á–∏—â–∞–µ–º –∫—ç—à Composer..."
    sudo -u www-data composer clear-cache
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
    echo "   üéØ –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏..."
    sudo -u www-data composer require drush/drush:^12.4 --no-interaction
    
    COMPOSER_RESULT2=$?
    echo "   üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏: $COMPOSER_RESULT2"
    
    if [ $COMPOSER_RESULT2 -ne 0 ]; then
        echo "   üåê –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
        composer global require drush/drush
        
        # –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
        if [ -f "$HOME/.composer/vendor/bin/drush" ]; then
            mkdir -p vendor/bin
            ln -sf "$HOME/.composer/vendor/bin/drush" vendor/bin/drush
            echo "   üîó –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π Drush"
        fi
    fi
fi

echo "   üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vendor/bin –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
ls -la vendor/bin/ 2>/dev/null || echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è vendor/bin –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–ª—Å—è
if [ -f vendor/bin/drush ]; then
    echo "‚úÖ –§–∞–π–ª Drush —Å–æ–∑–¥–∞–Ω: $(ls -la vendor/bin/drush)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    sudo chown www-data:www-data vendor/bin/drush
    sudo chmod +x vendor/bin/drush
    
    echo "   ‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º Drush
    echo "   üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º Drush..."
    if sudo -u www-data vendor/bin/drush --version; then
        echo "   ‚úÖ Drush —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    else
        echo "   ‚ùå Drush –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
    fi
else
    echo "‚ùå –§–∞–π–ª Drush –Ω–µ —Å–æ–∑–¥–∞–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫"
    echo "   üì• –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è..."
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    mkdir -p vendor/bin
    
    # –°–∫–∞—á–∏–≤–∞–µ–º Drush –Ω–∞–ø—Ä—è–º—É—é
    echo "   üì• –°–∫–∞—á–∏–≤–∞–µ–º Drush.phar..."
    wget -O vendor/bin/drush https://github.com/drush-ops/drush/releases/download/12.4.3/drush.phar
    
    if [ $? -eq 0 ]; then
        chmod +x vendor/bin/drush
        chown www-data:www-data vendor/bin/drush
        
        echo "   ‚úÖ Drush —Å–∫–∞—á–∞–Ω –Ω–∞–ø—Ä—è–º—É—é"
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–∞—á–∞–Ω–Ω—ã–π Drush
        echo "   üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–∞—á–∞–Ω–Ω—ã–π Drush..."
        if sudo -u www-data vendor/bin/drush --version; then
            echo "   ‚úÖ –°–∫–∞—á–∞–Ω–Ω—ã–π Drush —Ä–∞–±–æ—Ç–∞–µ—Ç!"
        else
            echo "   ‚ùå –°–∫–∞—á–∞–Ω–Ω—ã–π Drush –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
        fi
    else
        echo "   ‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Drush"
    fi
fi

echo "üîç –û–¢–õ–ê–î–ö–ê: –ó–∞–≤–µ—Ä—à–∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É Drush"

echo "5.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Drush..."
DRUSH_AVAILABLE=false
DRUSH_CMD=""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π Drush (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if [ -f "$DRUPAL_DIR/vendor/bin/drush" ]; then
    echo "   –¢–µ—Å—Ç–∏—Ä—É–µ–º Drush..."
    if sudo -u www-data "$DRUPAL_DIR/vendor/bin/drush" --version >/dev/null 2>&1; then
        DRUSH_AVAILABLE=true
        DRUSH_CMD="$DRUPAL_DIR/vendor/bin/drush"
        echo "‚úÖ Drush —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç: $DRUSH_CMD"
    else
        echo "   ‚ùå Drush –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
        echo "   –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
        sudo chown -R www-data:www-data "$DRUPAL_DIR/vendor/bin/drush"
        sudo chmod +x "$DRUPAL_DIR/vendor/bin/drush"
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if sudo -u www-data "$DRUPAL_DIR/vendor/bin/drush" --version >/dev/null 2>&1; then
            DRUSH_AVAILABLE=true
            DRUSH_CMD="$DRUPAL_DIR/vendor/bin/drush"
            echo "‚úÖ Drush –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç: $DRUSH_CMD"
        fi
    fi
else
    echo "   ‚ùå –§–∞–π–ª Drush –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
    echo "   –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    sudo -u www-data composer remove drush/drush --no-interaction || true
    sudo -u www-data composer require drush/drush --no-interaction
    
    if [ -f "$DRUPAL_DIR/vendor/bin/drush" ]; then
        sudo chown -R www-data:www-data "$DRUPAL_DIR/vendor/bin/drush"
        sudo chmod +x "$DRUPAL_DIR/vendor/bin/drush"
        
        if sudo -u www-data "$DRUPAL_DIR/vendor/bin/drush" --version >/dev/null 2>&1; then
            DRUSH_AVAILABLE=true
            DRUSH_CMD="$DRUPAL_DIR/vendor/bin/drush"
            echo "‚úÖ Drush –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç: $DRUSH_CMD"
        fi
    fi
fi

if [ "$DRUSH_AVAILABLE" = false ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Drush - –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤–µ–±-—É—Å—Ç–∞–Ω–æ–≤–∫–∞"
fi

echo "6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏..."
cd $DRUPAL_DIR

# –ú–æ–¥—É–ª–∏ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
DRUPAL_MODULES=(
    "drupal/admin_toolbar"
    "drupal/pathauto"
    "drupal/metatag"
    "drupal/token"
    "drupal/ctools"
    "drupal/views_bulk_operations"
    "drupal/entity_reference_revisions"
    "drupal/paragraphs"
    "drupal/field_group"
    "drupal/search_api"
    "drupal/search_api_db"
    "drupal/facets"
    "drupal/media_library_edit"
    "drupal/file_browser"
    "drupal/backup_migrate"
    "drupal/redis"
    "drupal/memcache"
)

echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª–µ–π –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã..."
for module in "${DRUPAL_MODULES[@]}"; do
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ $module..."
    sudo -u www-data COMPOSER_ALLOW_SUPERUSER=1 composer require $module --no-interaction
    if [ $? -ne 0 ]; then
        echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ $module, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
    fi
done

echo "7. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏..."
sudo -u www-data COMPOSER_ALLOW_SUPERUSER=1 composer require drupal/bootstrap5 --no-interaction

echo "8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
chown -R www-data:www-data $DRUPAL_DIR
find $DRUPAL_DIR -type d -exec chmod 755 {} \;
find $DRUPAL_DIR -type f -exec chmod 644 {} \;

# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
chmod 444 $DRUPAL_DIR/web/sites/default/default.settings.php

echo "9. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –¥–ª—è —Ñ–∞–π–ª–æ–≤..."
mkdir -p $DRUPAL_DIR/web/sites/default/files
mkdir -p $DRUPAL_DIR/web/sites/default/files/private
mkdir -p $DRUPAL_DIR/web/sites/default/files/translations
mkdir -p $DRUPAL_DIR/web/sites/default/files/backup

chown -R www-data:www-data $DRUPAL_DIR/web/sites/default/files
chmod -R 755 $DRUPAL_DIR/web/sites/default/files

echo "10. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
cp $DRUPAL_DIR/web/sites/default/default.settings.php $DRUPAL_DIR/web/sites/default/settings.php
chown www-data:www-data $DRUPAL_DIR/web/sites/default/settings.php
chmod 666 $DRUPAL_DIR/web/sites/default/settings.php

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if [ -f "/root/drupal-db-credentials.txt" ]; then
    DB_PASSWORD=$(grep "–ü–∞—Ä–æ–ª—å:" /root/drupal-db-credentials.txt | awk '{print $2}')
    echo "‚úÖ –î–∞–Ω–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–µ–Ω—ã"
else
    echo "‚ùå –§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "11. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ settings.php..."
cat >> $DRUPAL_DIR/web/sites/default/settings.php << EOF

/**
 * RTTI Digital Library Configuration
 * Generated: $(date)
 */

// Database configuration
\$databases['default']['default'] = [
  'database' => 'drupal_library',
  'username' => 'drupaluser',
  'password' => '$DB_PASSWORD',
  'prefix' => '',
  'host' => 'localhost',
  'port' => '5432',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\pgsql',
  'driver' => 'pgsql',
  'autoload' => 'core/modules/pgsql/src/Driver/Database/pgsql/',
];

// Trusted host patterns
\$settings['trusted_host_patterns'] = [
  '^storage\.omuzgorpro\.tj\$',
  '^www\.storage\.omuzgorpro\.tj\$',
];

// Salt for one-time login links, cancel links, form tokens, etc.
\$settings['hash_salt'] = '$(openssl rand -base64 75 | tr -d "=+/" | cut -c1-75)';

// Configuration sync directory
\$settings['config_sync_directory'] = '../config/sync';

// Private file path
\$settings['file_private_path'] = 'sites/default/files/private';

// Temporary file path
\$settings['file_temp_path'] = '/tmp';

EOF

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Redis
if [ -f "/root/drupal-cache-credentials.txt" ]; then
    REDIS_PASSWORD=$(grep "–ü–∞—Ä–æ–ª—å:" /root/drupal-cache-credentials.txt | awk '{print $2}')
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    cat >> $DRUPAL_DIR/web/sites/default/settings.php << EOF
// Redis configuration
\$settings['redis.connection']['interface'] = 'PhpRedis';
\$settings['redis.connection']['host'] = '127.0.0.1';
\$settings['redis.connection']['port'] = 6379;
\$settings['redis.connection']['password'] = '$REDIS_PASSWORD';
\$settings['redis.connection']['base'] = 0;

\$settings['cache']['default'] = 'cache.backend.redis';

// Bootstrap cache with Redis
\$settings['cache']['bins']['bootstrap'] = 'cache.backend.chainedfast';
\$settings['cache']['bins']['discovery'] = 'cache.backend.chainedfast';
\$settings['cache']['bins']['config'] = 'cache.backend.chainedfast';

// Memcached configuration (optional)
\$settings['memcache']['servers'] = ['127.0.0.1:11211' => 'default'];
\$settings['memcache']['bins'] = ['cache.page' => 'default'];

EOF
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
cat >> $DRUPAL_DIR/web/sites/default/settings.php << EOF
// RTTI Library specific settings
\$config['system.site']['name'] = 'RTTI Digital Library';
\$config['system.site']['slogan'] = '–¶–∏—Ñ—Ä–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ RTTI';
\$config['system.site']['mail'] = 'library@omuzgorpro.tj';

// Base URL configuration
\$base_url = 'https://storage.omuzgorpro.tj';

// Performance settings
\$config['system.performance']['css']['preprocess'] = TRUE;
\$config['system.performance']['js']['preprocess'] = TRUE;

// File system settings
\$config['system.file']['temporary_maximum_age'] = 86400;

// Logging
\$config['system.logging']['error_level'] = 'hide';

// Update notifications
\$config['update.settings']['notification']['emails'] = ['admin@omuzgorpro.tj'];

EOF

echo "12. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drupal —á–µ—Ä–µ–∑ CLI..."
echo "–ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Drupal..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMIN_PASSWORD="RTTIDrupal2024!"

cd $DRUPAL_DIR

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Drush –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
if [ "$DRUSH_AVAILABLE" = true ]; then
    echo "üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º Drush –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    echo "   –ö–æ–º–∞–Ω–¥–∞ Drush: $DRUSH_CMD"
    echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å..."
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Drush –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    if sudo -u www-data $DRUSH_CMD --version; then
        echo "‚úÖ Drush —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        echo "   –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
        echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
        ls -la
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ composer.json
        if [ -f "composer.json" ]; then
            echo "‚úÖ composer.json –Ω–∞–π–¥–µ–Ω"
        else
            echo "‚ùå composer.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            cd $DRUPAL_DIR
        fi
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Drupal..."
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drupal —á–µ—Ä–µ–∑ Drush (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
        sudo -u www-data $DRUSH_CMD site:install standard \
            --langcode=ru \
            --db-url=pgsql://drupaluser:$DB_PASSWORD@localhost:5432/drupal_library \
            --site-name="RTTI Digital Library" \
            --site-mail=library@omuzgorpro.tj \
            --account-name=admin \
            --account-pass=$ADMIN_PASSWORD \
            --account-mail=admin@omuzgorpro.tj \
            --yes

        INSTALL_RESULT=$?
    else
        echo "‚ùå Drush –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–µ–±-—É—Å—Ç–∞–Ω–æ–≤–∫—É"
        DRUSH_AVAILABLE=false
    fi
else
    echo "‚ö†Ô∏è Drush –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥..."
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ PHP —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    echo "üìç –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ settings.php
    cat >> $DRUPAL_DIR/web/sites/default/settings.php << EOF

// Database connection settings
\$databases['default']['default'] = [
  'database' => 'drupal_library',
  'username' => 'drupaluser',
  'password' => '$DB_PASSWORD',
  'prefix' => '',
  'host' => 'localhost',
  'port' => '5432',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\pgsql',
  'driver' => 'pgsql',
  'autoload' => 'core/modules/pgsql/src/Driver/Database/pgsql/',
];

// Salt for hashing
\$settings['hash_salt'] = '$(openssl rand -base64 32)';

// Site settings
\$settings['config_sync_directory'] = '../config/sync';
\$settings['file_private_path'] = '../private';

EOF

    echo "üìç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É —Å–µ—Ä–≤–µ—Ä–∞"
    INSTALL_RESULT=1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
if [ "${INSTALL_RESULT:-1}" -eq 0 ]; then
    echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drupal –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Drupal —á–µ—Ä–µ–∑ CLI –∏–ª–∏ Drush –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "üìå Drupal –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    echo "üìå –û—Ç–∫—Ä–æ–π—Ç–µ https://storage.omuzgorpro.tj –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
fi

echo "13. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
chmod 444 $DRUPAL_DIR/web/sites/default/settings.php
chown -R www-data:www-data $DRUPAL_DIR
find $DRUPAL_DIR/web/sites/default/files -type d -exec chmod 755 {} \;
find $DRUPAL_DIR/web/sites/default/files -type f -exec chmod 644 {} \;

echo "14. –í–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π..."
cd $DRUPAL_DIR

# –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Drupal —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ Drush –¥–æ—Å—Ç—É–ø–µ–Ω
if [ "$DRUSH_AVAILABLE" = true ] && [ $INSTALL_RESULT -eq 0 ]; then
    echo "üìç –í–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π —á–µ—Ä–µ–∑ Drush..."
    
    # –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
    CORE_MODULES=(
        "toolbar"
        "admin_toolbar"
        "admin_toolbar_tools"
        "pathauto"
        "metatag"
        "token"
        "views_ui"
        "media"
        "media_library"
        "search_api"
        "search_api_db"
    )

    for module in "${CORE_MODULES[@]}"; do
        echo "–í–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è $module..."
        sudo -u www-data $DRUSH_CMD pm:enable $module --yes 2>/dev/null || echo "‚ö†Ô∏è –ú–æ–¥—É–ª—å $module –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω"
    done
    
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π
    echo "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π..."
    sudo -u www-data $DRUSH_CMD cache:rebuild 2>/dev/null || true
    echo "üìç –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Drupal..."
    sudo -u www-data $DRUSH_CMD cache:rebuild 2>/dev/null || true
else
    echo "‚ö†Ô∏è –ú–æ–¥—É–ª–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
fi

echo "15. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Drupal..."
cat > /root/drupal-management.sh << EOF
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Drupal

DRUPAL_DIR="$DRUPAL_DIR"

# –ü–æ–∏—Å–∫ Drush
if [ -f "\$DRUPAL_DIR/vendor/bin/drush" ]; then
    DRUSH_CMD="\$DRUPAL_DIR/vendor/bin/drush"
    elif which drush >/dev/null 2>&1; then
        DRUSH_CMD="drush"
    else
        echo "‚ùå Drush –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
fi

case "\$1" in
    cache-clear)
        echo "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Drupal..."
        cd \$DRUPAL_DIR
        sudo -u www-data \$DRUSH_CMD cache:rebuild
        echo "‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω"
        ;;
    backup)
        echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ Drupal..."
        BACKUP_DIR="/var/backups/drupal/drupal-\$(date +%Y%m%d-%H%M%S)"
        mkdir -p \$BACKUP_DIR
        cp -r \$DRUPAL_DIR \$BACKUP_DIR/files
        sudo -u postgres pg_dump drupal_library > \$BACKUP_DIR/database.sql
        echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: \$BACKUP_DIR"
        ;;
    update)
        echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Drupal..."
        cd \$DRUPAL_DIR
        sudo -u www-data composer update --no-interaction
        sudo -u www-data \$DRUSH_CMD updatedb -y
        sudo -u www-data \$DRUSH_CMD cache:rebuild
        echo "‚úÖ Drupal –æ–±–Ω–æ–≤–ª–µ–Ω"
        ;;
    status)
        echo "–°—Ç–∞—Ç—É—Å Drupal:"
        cd \$DRUPAL_DIR
        sudo -u www-data \$DRUSH_CMD status
        ;;
    modules)
        echo "–°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π:"
        cd \$DRUPAL_DIR
        sudo -u www-data \$DRUSH_CMD pm:list --type=module --status=enabled
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: \$0 {cache-clear|backup|update|status|modules}"
        exit 1
        ;;
esac
EOF

chmod +x /root/drupal-management.sh

echo "16. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."

cat > /root/drupal-admin-credentials.txt << EOF
# –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Drupal
# –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: $(date)
# –°–µ—Ä–≤–µ—Ä: storage.omuzgorpro.tj ($(hostname -I | awk '{print $1}'))

URL: https://storage.omuzgorpro.tj
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: admin
–ü–∞—Ä–æ–ª—å: $ADMIN_PASSWORD
Email: admin@omuzgorpro.tj

# –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥:
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ https://storage.omuzgorpro.tj
# 2. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ admin —Å –ø–∞—Ä–æ–ª–µ–º –≤—ã—à–µ
# 3. –°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å
# 4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

# –í–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: https://storage.omuzgorpro.tj/admin
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º: https://storage.omuzgorpro.tj/admin/content
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: https://storage.omuzgorpro.tj/admin/config
# –ú–æ–¥—É–ª–∏: https://storage.omuzgorpro.tj/admin/modules
# –¢–µ–º—ã: https://storage.omuzgorpro.tj/admin/appearance

# Drush –∫–æ–º–∞–Ω–¥—ã:
# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞: cd $DRUPAL_DIR && sudo -u www-data $DRUSH_CMD cache:rebuild
# –°—Ç–∞—Ç—É—Å: cd $DRUPAL_DIR && sudo -u www-data $DRUSH_CMD status  
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: cd $DRUPAL_DIR && sudo -u www-data $DRUSH_CMD user:list
EOF

chmod 600 /root/drupal-admin-credentials.txt

echo "17. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞..."
cat > /root/drupal-installation-info.txt << EOF
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ Drupal 11
# –î–∞—Ç–∞: $(date)
# –°–µ—Ä–≤–µ—Ä: storage.omuzgorpro.tj ($(hostname -I | awk '{print $1}'))

=== –£–°–¢–ê–ù–û–í–ö–ê ===
–ü—É—Ç—å: $DRUPAL_DIR
–í–µ—Ä—Å–∏—è: $DRUPAL_VERSION
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: drupal_library (PostgreSQL)
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: Redis + Memcached + APCu

=== –î–û–°–¢–£–ü ===
URL: https://storage.omuzgorpro.tj
–ê–¥–º–∏–Ω: admin
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: /root/drupal-admin-credentials.txt

=== –ú–û–î–£–õ–ò ===
–ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã:
- Admin Toolbar (—É–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
- Pathauto (SEO URL)
- Metatag (SEO –º–µ—Ç–∞—Ç–µ–≥–∏)
- Search API (–ø–æ–∏—Å–∫)
- Media Library (–º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã)
- Redis (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

=== –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
–°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: /root/drupal-management.sh
–ö–æ–º–∞–Ω–¥—ã:
- cache-clear: –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
- backup: —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
- update: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- status: —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
- modules: —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π

=== –§–ê–ô–õ–´ ===
–ü—É–±–ª–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã: $DRUPAL_DIR/web/sites/default/files
–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã: $DRUPAL_DIR/web/sites/default/files/private
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $DRUPAL_DIR/web/sites/default/settings.php
Composer: $DRUPAL_DIR/composer.json

=== –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò ===
1. –û—Ç–∫—Ä–æ–π—Ç–µ https://storage.omuzgorpro.tj
2. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
4. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–∏—Å–∫ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./07-configure-drupal.sh

=== –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï ===
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –º–æ–¥—É–ª–∏: composer update
- –û—á–∏—â–∞–π—Ç–µ –∫—ç—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö: drush cache:rebuild  
- –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: /root/drupal-management.sh backup
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤: /var/log/nginx/ –∏ /var/log/php8.3-fpm.log
EOF

echo "18. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
if [ -f "$DRUPAL_DIR/web/sites/default/settings.php" ] && [ -d "$DRUPAL_DIR/web/core" ]; then
    echo "‚úÖ –§–∞–π–ª—ã Drupal —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π"
fi

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
sudo -u www-data php -r "
try {
    \$pdo = new PDO('pgsql:host=localhost;dbname=drupal_library', 'drupaluser', '$DB_PASSWORD');
    echo 'Database connection: OK\n';
} catch (Exception \$e) {
    echo 'Database connection: FAILED\n';
}
" 2>/dev/null

echo "19. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -f $DRUPAL_DIR/phpinfo.php 2>/dev/null || true

echo
echo "‚úÖ –®–∞–≥ 6 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üìå Drupal 11 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ $DRUPAL_DIR"
echo "üìå –ú–æ–¥—É–ª–∏ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo "üìå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
echo "üìå –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ"

if [ $INSTALL_RESULT -eq 0 ]; then
    echo "üìå ‚úÖ Drupal –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ CLI"
    echo "üìå URL: https://storage.omuzgorpro.tj"
    echo "üìå –õ–æ–≥–∏–Ω: admin / –ü–∞—Ä–æ–ª—å: RTTIDrupal2024!"
else
    echo "üìå ‚ö†Ô∏è –ó–∞–≤–µ—Ä—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:"
    echo "üìå URL: https://storage.omuzgorpro.tj"
    echo "üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ë–î –∏–∑: /root/drupal-db-credentials.txt"
    echo "üìå –°–æ–∑–¥–∞–π—Ç–µ —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
fi

echo "üìå –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: /root/drupal-admin-credentials.txt"
echo "üìå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: /root/drupal-management.sh"
echo "üìå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: /root/drupal-installation-info.txt"

if [ "$DRUSH_AVAILABLE" = true ]; then
    echo "üìå ‚úÖ Drush –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
else
    echo "üìå ‚ö†Ô∏è Drush –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ CLI"
fi

echo "üìå –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: ./07-configure-drupal.sh"
echo
